<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.ohmyssh.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="在Spring Boot2.0中集成Quartz考虑到业务中需要对任务进行实时修改，因此本文的配置方式可能较为复杂如果是想了解事务为何不生效的，先告诉结论：将Job中的RUN方法，提取成一个Class的方法，并在此方法上加@Transactional，在job.run中调用。具体原因请参考下文 以Spring Boot2.19版本为例，添加POM依赖：1234&lt;dependency&gt;">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot中使用quartz定时任务并进行事务管理">
<meta property="og:url" content="https://blog.ohmyssh.top/2019/11/05/spring-boot%E4%B8%AD%E4%BD%BF%E7%94%A8quartz%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B9%B6%E8%BF%9B%E8%A1%8C%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="Beiluo&#39;s Blog">
<meta property="og:description" content="在Spring Boot2.0中集成Quartz考虑到业务中需要对任务进行实时修改，因此本文的配置方式可能较为复杂如果是想了解事务为何不生效的，先告诉结论：将Job中的RUN方法，提取成一个Class的方法，并在此方法上加@Transactional，在job.run中调用。具体原因请参考下文 以Spring Boot2.19版本为例，添加POM依赖：1234&lt;dependency&gt;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-05T09:39:47.000Z">
<meta property="article:modified_time" content="2024-05-20T01:15:40.127Z">
<meta property="article:author" content="北落never">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="quartz">
<meta property="article:tag" content="事务">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.ohmyssh.top/2019/11/05/spring-boot%E4%B8%AD%E4%BD%BF%E7%94%A8quartz%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B9%B6%E8%BF%9B%E8%A1%8C%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.ohmyssh.top/2019/11/05/spring-boot%E4%B8%AD%E4%BD%BF%E7%94%A8quartz%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B9%B6%E8%BF%9B%E8%A1%8C%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/","path":"2019/11/05/spring-boot中使用quartz定时任务并进行事务管理/","title":"Spring Boot中使用quartz定时任务并进行事务管理"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spring Boot中使用quartz定时任务并进行事务管理 | Beiluo's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Beiluo's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8Spring-Boot2-0%E4%B8%AD%E9%9B%86%E6%88%90Quartz"><span class="nav-number">1.</span> <span class="nav-text">在Spring Boot2.0中集成Quartz</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A5Spring-Boot2-19%E7%89%88%E6%9C%AC%E4%B8%BA%E4%BE%8B%EF%BC%8C%E6%B7%BB%E5%8A%A0POM%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-number">1.1.</span> <span class="nav-text">以Spring Boot2.19版本为例，添加POM依赖：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%90%84%E7%A7%8DConfigBean"><span class="nav-number">1.2.</span> <span class="nav-text">添加各种ConfigBean</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A0%E6%95%88%E9%97%AE%E9%A2%98%E5%87%BA%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">事务无效问题出现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">2.1.</span> <span class="nav-text">问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B%E5%8E%9F%E5%9B%A0"><span class="nav-number">2.1.1.</span> <span class="nav-text">启用日志查看原因</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">北落never</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.ohmyssh.top/2019/11/05/spring-boot%E4%B8%AD%E4%BD%BF%E7%94%A8quartz%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B9%B6%E8%BF%9B%E8%A1%8C%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北落never">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Beiluo's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Spring Boot中使用quartz定时任务并进行事务管理 | Beiluo's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Boot中使用quartz定时任务并进行事务管理
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-05 09:39:47" itemprop="dateCreated datePublished" datetime="2019-11-05T09:39:47+00:00">2019-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-20 01:15:40" itemprop="dateModified" datetime="2024-05-20T01:15:40+00:00">2024-05-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="在Spring-Boot2-0中集成Quartz"><a href="#在Spring-Boot2-0中集成Quartz" class="headerlink" title="在Spring Boot2.0中集成Quartz"></a>在Spring Boot2.0中集成Quartz</h2><p>考虑到业务中需要对任务进行实时修改，因此本文的配置方式可能较为复杂<br>如果是想了解事务为何不生效的，先告诉结论：将Job中的RUN方法，提取成一个Class的方法，并在此方法上加@Transactional，在job.run中调用。具体原因请参考下文</p>
<h3 id="以Spring-Boot2-19版本为例，添加POM依赖："><a href="#以Spring-Boot2-19版本为例，添加POM依赖：" class="headerlink" title="以Spring Boot2.19版本为例，添加POM依赖："></a>以Spring Boot2.19版本为例，添加POM依赖：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>父项目为Spring Boot</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.1.9.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">&lt;/parent&gt;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="添加各种ConfigBean"><a href="#添加各种ConfigBean" class="headerlink" title="添加各种ConfigBean"></a>添加各种ConfigBean</h3><p>QuartzConfig.java:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import org.quartz.Scheduler;</span><br><span class="line">import org.quartz.spi.JobFactory;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Scope;</span><br><span class="line">import org.springframework.scheduling.quartz.SchedulerFactoryBean;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class QuartzConfig &#123;</span><br><span class="line"></span><br><span class="line">	private JobFactory jobFactory;</span><br><span class="line"></span><br><span class="line">	public QuartzConfig(JobFactory jobFactory) &#123;</span><br><span class="line">		this.jobFactory = jobFactory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 配置SchedulerFactoryBean</span><br><span class="line">	 *</span><br><span class="line">	 * 将一个方法产生为Bean并交给Spring容器管理</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	@Scope(&quot;singleton&quot;)</span><br><span class="line">	public SchedulerFactoryBean schedulerFactoryBean() &#123;</span><br><span class="line">		// Spring提供SchedulerFactoryBean为Scheduler提供配置信息,并被Spring容器管理其生命周期</span><br><span class="line">		SchedulerFactoryBean factory = new SchedulerFactoryBean();</span><br><span class="line">		// 设置自定义Job Factory，用于Spring管理Job bean</span><br><span class="line">		factory.setJobFactory(jobFactory);</span><br><span class="line">		return factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean(name = &quot;scheduler&quot;)</span><br><span class="line">	public Scheduler scheduler() &#123;</span><br><span class="line">		return schedulerFactoryBean().getScheduler();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JobFactory.java 用于管理Job</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import org.quartz.spi.TriggerFiredBundle;</span><br><span class="line">import org.springframework.beans.factory.config.AutowireCapableBeanFactory;</span><br><span class="line">import org.springframework.scheduling.quartz.AdaptableJobFactory;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author beiluo</span><br><span class="line"> * 解决SpringBoot不能再Quartz中注入Bean的问题</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class JobFactory extends AdaptableJobFactory &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * AutowireCapableBeanFactory接口是BeanFactory的子类</span><br><span class="line">	 * 可以连接和填充那些生命周期不被Spring管理的已存在的bean实例</span><br><span class="line">	 */</span><br><span class="line">	private AutowireCapableBeanFactory factory;</span><br><span class="line"></span><br><span class="line">	public JobFactory(AutowireCapableBeanFactory factory) &#123;</span><br><span class="line">		this.factory = factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 创建Job实例</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	protected Object createJobInstance(TriggerFiredBundle bundle) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		// 实例化对象</span><br><span class="line">		Object job = super.createJobInstance(bundle);</span><br><span class="line">		// 进行注入（Spring管理该Bean）</span><br><span class="line">		factory.autowireBean(job);</span><br><span class="line">		// 返回对象</span><br><span class="line">		return job;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>QuartzConfigration.java  用于管理所有的job，可以根据自己的业务进行修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">import org.quartz.*;</span><br><span class="line">import org.quartz.impl.matchers.GroupMatcher;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class QuartzConfigration &#123;</span><br><span class="line"></span><br><span class="line">    private final static String JOB_GROUP_NAME = &quot;JOB_GROUP&quot;;</span><br><span class="line"></span><br><span class="line">    private final static String TRIGGER_GROUP_NAME = &quot;TRIGGER_GROUP&quot;;</span><br><span class="line"></span><br><span class="line">    private static Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    public QuartzConfigration(Scheduler scheduler) &#123;</span><br><span class="line">        QuartzConfigration.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param jobName     任务名</span><br><span class="line">     * @param triggerName 触发器名</span><br><span class="line">     * @param jobClass    任务</span><br><span class="line">     * @param cron        时间设置</span><br><span class="line">     * @Description: 添加定时任务</span><br><span class="line">     */</span><br><span class="line">    public static boolean addJob(String jobName, String triggerName, Class&lt;? extends Job&gt; jobClass, String cron) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 任务名，任务组，任务执行类</span><br><span class="line">            JobDetail jobDetail = JobBuilder.newJob(jobClass).withIdentity(jobName, JOB_GROUP_NAME).build();</span><br><span class="line">            // 触发器</span><br><span class="line">            TriggerBuilder&lt;Trigger&gt; triggerBuilder = TriggerBuilder.newTrigger();</span><br><span class="line">            // 触发器名,触发器组</span><br><span class="line">            triggerBuilder.withIdentity(triggerName, TRIGGER_GROUP_NAME);</span><br><span class="line">            triggerBuilder.startNow();</span><br><span class="line">            // 触发器时间设定</span><br><span class="line">            triggerBuilder.withSchedule(CronScheduleBuilder.cronSchedule(cron));</span><br><span class="line">            // 创建Trigger对象</span><br><span class="line">            CronTrigger trigger = (CronTrigger) triggerBuilder.build();</span><br><span class="line">            // 调度容器设置JobDetail和Trigger</span><br><span class="line">            scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line">            // 启动</span><br><span class="line">            if (!scheduler.isShutdown()) &#123;</span><br><span class="line">                scheduler.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 启动</span><br><span class="line">            if (!scheduler.isShutdown()) &#123;</span><br><span class="line">                scheduler.start();</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param jobName     任务名</span><br><span class="line">     * @param triggerName 触发器名</span><br><span class="line">     * @param cron        时间设置</span><br><span class="line">     * @Description: 修改任务的触发时间</span><br><span class="line">     */</span><br><span class="line">    public static boolean modifyJobTime(String jobName, String triggerName, String cron) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // Scheduler sched = schedulerFactory.getScheduler();</span><br><span class="line">            TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, TRIGGER_GROUP_NAME);</span><br><span class="line">            CronTrigger trigger = (CronTrigger) scheduler.getTrigger(triggerKey);</span><br><span class="line">            if (trigger == null) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String oldTime = trigger.getCronExpression();</span><br><span class="line">            if (!oldTime.equalsIgnoreCase(cron)) &#123;</span><br><span class="line">                /* 方式一 ：调用 rescheduleJob 开始 */</span><br><span class="line">                // 触发器</span><br><span class="line">                TriggerBuilder&lt;Trigger&gt; triggerBuilder = TriggerBuilder.newTrigger();</span><br><span class="line">                // 触发器名,触发器组</span><br><span class="line">                triggerBuilder.withIdentity(triggerName, TRIGGER_GROUP_NAME);</span><br><span class="line">                triggerBuilder.startNow();</span><br><span class="line">                // 触发器时间设定</span><br><span class="line">                triggerBuilder.withSchedule(CronScheduleBuilder.cronSchedule(cron));</span><br><span class="line">                // 创建Trigger对象</span><br><span class="line">                trigger = (CronTrigger) triggerBuilder.build();</span><br><span class="line">                // 方式一 ：修改任务的触发时间</span><br><span class="line">                scheduler.rescheduleJob(triggerKey, trigger);</span><br><span class="line">                /* 方式一 ：调用 rescheduleJob 结束 */</span><br><span class="line">                /* 方式二：先删除，然后在创建新的Job */</span><br><span class="line">                // JobDetail jobDetail = sched.getJobDetail(JobKey.jobKey(jobName,</span><br><span class="line">                // JOB_GROUP_NAME));</span><br><span class="line">                // Class&lt;? extends Job&gt; jobClass = jobDetail.getJobClass();</span><br><span class="line">                // removeJob(jobName, JOB_GROUP_NAME, triggerName, TRIGGER_GROUP_NAME);</span><br><span class="line">                // addJob(jobName, JOB_GROUP_NAME, triggerName, TRIGGER_GROUP_NAME, jobClass,</span><br><span class="line">                // cron);</span><br><span class="line">                /* 方式二 ：先删除，然后在创建新的Job */</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param jobName     任务名</span><br><span class="line">     * @param triggerName 触发器名</span><br><span class="line">     * @Description: 删除任务</span><br><span class="line">     */</span><br><span class="line">    public static boolean removeJob(String jobName, String triggerName) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, TRIGGER_GROUP_NAME);</span><br><span class="line">            scheduler.pauseTrigger(triggerKey);// 停止触发器</span><br><span class="line">            scheduler.unscheduleJob(triggerKey);// 移除触发器</span><br><span class="line">            scheduler.deleteJob(JobKey.jobKey(jobName, JOB_GROUP_NAME));// 删除任务</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 启动所有任务</span><br><span class="line">     */</span><br><span class="line">    public static boolean startAllJobs() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            scheduler.start();</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 关闭所有任务</span><br><span class="line">     */</span><br><span class="line">    public static boolean shutdownAllJobs() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (!scheduler.isShutdown()) &#123;</span><br><span class="line">                scheduler.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 暂停当前任务</span><br><span class="line">     */</span><br><span class="line">    public static boolean pauseJob(String jobName) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            scheduler.pauseJob(JobKey.jobKey(jobName, JOB_GROUP_NAME));</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 开启当前任务</span><br><span class="line">     */</span><br><span class="line">    public static boolean resumeJob(String jobName) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            scheduler.resumeJob(JobKey.jobKey(jobName, JOB_GROUP_NAME));</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取所有任务名称</span><br><span class="line">     *</span><br><span class="line">     * @return 所有任务名</span><br><span class="line">     * @throws SchedulerException</span><br><span class="line">     */</span><br><span class="line">    public static Map&lt;String, String&gt; getAllJobName() &#123;</span><br><span class="line">        Map&lt;String, String&gt; jobNameTrigger = new HashMap&lt;&gt;();</span><br><span class="line">        try &#123;</span><br><span class="line">            scheduler.getJobGroupNames().forEach(group -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    scheduler.getJobKeys(GroupMatcher.jobGroupEquals(group)).forEach(jobKey -&gt; &#123;</span><br><span class="line">                        String jobName = jobKey.getName();</span><br><span class="line">                        try &#123;</span><br><span class="line">                            List&lt;? extends Trigger&gt; triggers = scheduler.getTriggersOfJob(jobKey);</span><br><span class="line">                            String triggerName = triggers.get(0).getKey().getName();</span><br><span class="line"></span><br><span class="line">                            jobNameTrigger.put(jobName,triggerName);</span><br><span class="line">                        &#125; catch (SchedulerException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; catch (SchedulerException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return jobNameTrigger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为需要动态的修改Job，因此项目中所有Job配置放置于数据库中，在系统启动时初始化所有Job，当有Job变化时，进行reload操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">import com....entity.QuartzConfigBean;</span><br><span class="line">import com...QuartzConfigration;</span><br><span class="line">import com...service.IQuartzConfigService;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.quartz.Job;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.CommandLineRunner;</span><br><span class="line">import org.springframework.core.annotation.Order;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">@Order(value = 1)</span><br><span class="line">public class QuartzInitRunner implements CommandLineRunner &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 日志</span><br><span class="line">     */</span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private IQuartzConfigService quartzConfigService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... arg0) throws Exception &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 加载数据字典数据到内存.</span><br><span class="line">     */</span><br><span class="line">    private void load() &#123;</span><br><span class="line">        logger.info(&quot;启动初始化Quart加载项.....start&quot;);</span><br><span class="line"></span><br><span class="line">        List&lt;QuartzConfigBean&gt; list = quartzConfigService.getAllList();</span><br><span class="line"></span><br><span class="line">        if (list != null)</span><br><span class="line">            list.forEach(quartzConfig -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    QuartzConfigration.addJob(quartzConfig.getJobName(), quartzConfig.getTriggerName(), (Class&lt;? extends Job&gt;) Class.forName(quartzConfig.getExecuteClassPath()), quartzConfig.getQuartzCron());</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    logger.error(&quot;初始化class失败，class不存在！&#123;&#125;&quot;, quartzConfig.getExecuteClassPath());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        logger.info(&quot;启动初始化Quart加载项.....end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 重新加载任务的执行时间</span><br><span class="line">     */</span><br><span class="line">    public boolean reload() &#123;</span><br><span class="line">        logger.info(&quot;重新加载所有任务.....start&quot;);</span><br><span class="line">        List&lt;QuartzConfigBean&gt; jobs = quartzConfigService.getAllList();</span><br><span class="line">        Map&lt;String, String&gt; jobTrigger = QuartzConfigration.getAllJobName();</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; dbJobNames = new ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; quartzAllJobs = new ArrayList&lt;&gt;(jobTrigger.keySet());</span><br><span class="line"></span><br><span class="line">        AtomicBoolean flag = new AtomicBoolean(true);</span><br><span class="line">        jobs.forEach(configBean -&gt; &#123;</span><br><span class="line">            String jobName = configBean.getJobName();</span><br><span class="line">            String triggerName = configBean.getTriggerName();</span><br><span class="line">            dbJobNames.add(configBean.getJobName());</span><br><span class="line">            boolean result = false;</span><br><span class="line">            if (jobTrigger.values().contains(jobName)) &#123;</span><br><span class="line">                result = QuartzConfigration.modifyJobTime(jobName, triggerName, configBean.getQuartzCron());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                try &#123;</span><br><span class="line"></span><br><span class="line">                    Class&lt;?&gt; jobClazz = Class.forName(configBean.getExecuteClassPath());</span><br><span class="line">                    result = QuartzConfigration.addJob(jobName, triggerName,</span><br><span class="line">                            (Class&lt;? extends Job&gt;) jobClazz, configBean.getQuartzCron());</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    logger.error(&quot;初始化class失败，class不存在！&#123;&#125;&quot;, configBean.getExecuteClassPath());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //更新cron,</span><br><span class="line">            if (!result) &#123;</span><br><span class="line">                flag.set(false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //获取当前内存中job和数据库中job差集</span><br><span class="line">        quartzAllJobs.removeAll(dbJobNames);</span><br><span class="line">        quartzAllJobs.forEach(job -&gt; &#123;</span><br><span class="line">            //删除数据库中不存在的jobs</span><br><span class="line">            if (StringUtils.isNotEmpty(jobTrigger.get(job))) &#123;</span><br><span class="line">                QuartzConfigration.removeJob(job, jobTrigger.get(job));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        //获取现在执行的job，重新load</span><br><span class="line">        logger.info(&quot;重新加载所有任务.....end&quot;);</span><br><span class="line">        return flag.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表结构如下,此处也可根据自己的业务进行修改，仅供参考：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `quartz_config`  (</span><br><span class="line">  `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT &#x27;主键&#x27;,</span><br><span class="line">  `quartz_name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;具体任务名&#x27;,</span><br><span class="line">  `job_name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;任务名&#x27;,</span><br><span class="line">  `trigger_name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;触发器名&#x27;,</span><br><span class="line">  `quartz_cycle` char(1) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;字典值frequency 1每月 2每周 3每日 &#x27;,</span><br><span class="line">  `execute_time` time(6) NOT NULL COMMENT &#x27;执行时间 时分秒&#x27;,</span><br><span class="line">  `quartz_cron` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;cron表达式&#x27;,</span><br><span class="line">  `execute_class_path` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;执行类路径&#x27;,</span><br><span class="line">  `is_delete` tinyint(1) NOT NULL DEFAULT 0 COMMENT &#x27;是否删除&#x27;,</span><br><span class="line">  `type` varchar(1) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT &#x27;任务类型&#x27;,</span><br><span class="line">  `associated_id` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT &#x27;数据关联id&#x27;,</span><br><span class="line">  `status` varchar(1) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;任务状态 1正在执行 2已暂停 &#x27;,</span><br><span class="line">  `start_time` datetime(0) DEFAULT NULL COMMENT &#x27;任务开始时间&#x27;,</span><br><span class="line">  `end_time` datetime(0) DEFAULT NULL COMMENT &#x27;任务结束时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = 66 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>编写业务代码implements org.quartz.Job</p>
<h2 id="事务无效问题出现"><a href="#事务无效问题出现" class="headerlink" title="事务无效问题出现"></a>事务无效问题出现</h2><p>在run方法上添加@Transactional注解，发现事务没有生效，伪代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Transactional(rollbackFor = Exception.class)</span><br><span class="line">public void run()&#123;</span><br><span class="line">	userService.remove();</span><br><span class="line">	int a = 1/0;</span><br><span class="line">	userService.saveBatch(saveUsers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><ol>
<li>检查事务注解是否添加，是否启用<ul>
<li><del>Spring Boot的@SpringBootApplication默认添加了@EnableTransactionManagement</del> 添加了@EnableTransactionManagement无效</li>
</ul>
</li>
<li>了解到事务是对<del>@Service注解</del> Spring托管的类 下public 方法进行切入，检查了当前类是否被Spring托管<ul>
<li>已经使用@Component ，切换为@Service，依旧没有效果</li>
</ul>
</li>
</ol>
<h4 id="启用日志查看原因"><a href="#启用日志查看原因" class="headerlink" title="启用日志查看原因"></a>启用日志查看原因</h4><p>在application.yaml或applicationproperties添加Debug</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    org.springframework.jdbc.datasource: debug</span><br></pre></td></tr></table></figure>

<p>观察日志发现没有开启create transaction，翻看源码发现在Job.run()方法调用方中，使用try catch对异常进行了捕捉。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class JobRunShell extends SchedulerListenerSupport implements Runnable &#123;</span><br><span class="line">	……</span><br><span class="line">	public void run() &#123;</span><br><span class="line">			……</span><br><span class="line">			// execute the job</span><br><span class="line">            try &#123;</span><br><span class="line">                log.debug(&quot;Calling execute on job &quot; + jobDetail.getKey());</span><br><span class="line">                job.execute(jec);</span><br><span class="line">                endTime = System.currentTimeMillis();</span><br><span class="line">            &#125; catch (JobExecutionException jee) &#123;</span><br><span class="line">                endTime = System.currentTimeMillis();</span><br><span class="line">                jobExEx = jee;</span><br><span class="line">                getLog().info(&quot;Job &quot; + jobDetail.getKey() +</span><br><span class="line">                &quot; threw a JobExecutionException: &quot;, jobExEx);</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                endTime = System.currentTimeMillis();</span><br><span class="line">                getLog().error(&quot;Job &quot; + jobDetail.getKey() +</span><br><span class="line">                &quot; threw an unhandled Exception: &quot;, e);</span><br><span class="line">                SchedulerException se = new SchedulerException(</span><br><span class="line">                &quot;Job threw an unhandled exception.&quot;, e);</span><br><span class="line">                qs.notifySchedulerListenersError(&quot;Job (&quot;</span><br><span class="line">                + jec.getJobDetail().getKey()</span><br><span class="line">                + &quot; threw an exception.&quot;, se);</span><br><span class="line">                jobExEx = new JobExecutionException(se, false);</span><br><span class="line">            &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>因此通常的事务处理会被此处拦截掉，所以要把方法从excute中拿出来。</strong></p>
<p>这里大致进行了如下修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void execute()&#123;</span><br><span class="line">	userSync()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Transactional(rollbackFor = Exception.class)</span><br><span class="line">public void userSync()&#123;</span><br><span class="line">	userService.remove();</span><br><span class="line">	int a = 1/0;</span><br><span class="line">	userService.saveBatch(saveUsers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际测试依旧无效，这里涉及到另一个知识点：</p>
<p><strong>Spring的Aop原理：默认使用Cglib方式做切面，只能在不同类中调用才能正常使用到Spring提供的切面服务</strong></p>
<p>最后修改方案为把具体业务抽取到另一个类中，在Job类中注入这个类调用方法。</p>
<p>大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class UserSyncJob implements Job &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">    UserSyncServiceImpl syncService;</span><br><span class="line">	</span><br><span class="line">    public void execute()&#123;</span><br><span class="line">        syncService.cleanUserAndSync()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Compoment//@Service 没有明显区别</span><br><span class="line">public class UserSyncServiceImpl &#123;</span><br><span class="line"></span><br><span class="line">	@Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public void cleanUserAndSync() &#123;</span><br><span class="line">    	userService.remove();</span><br><span class="line">        userService.saveBatch(saveUsers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>添加中间类后的日志,删减了部分</p>
<blockquote>
<p><em>2019-11-06 11:25:00.023 DEBUG 14228 — [ryBean_Worker-1] o.s.j.d.DataSourceTransactionManager     : <strong>Creating new transaction with name [UserSyncServiceImpl.cleanUserAndSync]:</strong> PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception<br>2019-11-06 11:25:00.058 DEBUG 14228 — [ryBean_Worker-1] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@406789872 wrapping com.mysql.cj.jdbc.ConnectionImpl@1c9d21d9] for JDBC transaction<br>2019-11-06 11:25:00.061 DEBUG 14228 — [ryBean_Worker-1] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@406789872 wrapping com.mysql.cj.jdbc.ConnectionImpl@1c9d21d9] to manual commit<br>2019-11-06 11:25:01.038 DEBUG 14228 — [ryBean_Worker-1] o.s.j.d.DataSourceTransactionManager     : <strong>Initiating transaction rollback</strong><br>2019-11-06 11:25:01.038 DEBUG 14228 — [ryBean_Worker-1] o.s.j.d.DataSourceTransactionManager     : Rolling back JDBC transaction on Connection [HikariProxyConnection@406789872 wrapping com.mysql.cj.jdbc.ConnectionImpl@1c9d21d9]<br>2019-11-06 11:25:01.226 DEBUG 14228 — [ryBean_Worker-1] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@406789872 wrapping com.mysql.cj.jdbc.ConnectionImpl@1c9d21d9] after transaction</em></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SpringBoot/" rel="tag"># SpringBoot</a>
              <a href="/tags/quartz/" rel="tag"># quartz</a>
              <a href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag"># 事务</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/2019/11/08/PKI%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%BB%8B%E7%BB%8D-%E7%AC%AC%E4%B8%80%E7%AF%87/" rel="next" title="PKI基础知识介绍-第一篇">
                  PKI基础知识介绍-第一篇 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">北落never</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"}});</script></body>
</html>
